{% extends "base.html" %}
{% block title %}Dashboard{% endblock %}

{% block content %}

<!-- ===== NOTIFICATIONS (EMPLOYEE / HR) ===== -->
{% if notifications %}
<div style="margin-bottom:20px;">
    {% for n in notifications %}
        <div style="
            background:#e9f7ef;
            padding:10px;
            border-left:5px solid green;
            margin-bottom:8px;
        ">
            ğŸ”” {{ n.message }}
        </div>
    {% endfor %}
</div>
{% endif %}

<!-- ===== FLASH MESSAGES ===== -->
{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    {% for category, message in messages %}
      <div class="alert alert-{{ category }}">
        ğŸ”” {{ message }}
      </div>
    {% endfor %}
  {% endif %}
{% endwith %}

<!-- ===== DASHBOARD CARDS ===== -->
<div class="cards">

    <div class="card total">
        <h4>Total Grievances</h4>
        <p>{{ total }}</p>
        <i>ğŸ“‚</i>
    </div>

    <div class="card pending">
        <h4>Pending Issues</h4>
        <p>{{ pending }}</p>
        <i>â³</i>
    </div>

    <div class="card resolved">
        <h4>Resolved</h4>
        <p>{{ resolved }}</p>
        <i>âœ…</i>
    </div>

</div>

<!-- ===== ACTION BUTTONS ===== -->
<div style="margin: 20px 0;">
    {% if session.role == "employee" %}
        <a href="{{ url_for('add_grievance') }}" class="btn">
            â• Add Grievance
        </a>
    {% endif %}

    {% if session.role == "hr" %}
        <a href="{{ url_for('grievances_page') }}" class="btn">
            ğŸ“‚ View / Resolve Grievances
        </a>
        <a href="{{ url_for('leaves.my_leaves') }}" class="btn">
            ğŸ“„ My Leave Status
        </a>
    {% endif %}
</div>

<!-- ===== CHART ===== -->
<div class="charts">
    <div class="chart-box">
        <h3>Grievance Status</h3>
        <canvas id="grievanceChart"></canvas>
    </div>
</div>

<!-- ===== CHART JS ===== -->
<script>
const canvas = document.getElementById('grievanceChart');
const ctx = canvas.getContext('2d');

const pendingGradient = ctx.createLinearGradient(0, 0, 0, 300);
pendingGradient.addColorStop(0, '#ffb300');
pendingGradient.addColorStop(1, '#f57c00');

const resolvedGradient = ctx.createLinearGradient(0, 0, 0, 300);
resolvedGradient.addColorStop(0, '#43a047');
resolvedGradient.addColorStop(1, '#1b5e20');

new Chart(ctx, {
    type: 'doughnut',
    data: {
        labels: ['Pending', 'Resolved'],
        datasets: [{
            data: [{{ pending }}, {{ resolved }}],
            backgroundColor: [pendingGradient, resolvedGradient],
            borderWidth: 2
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'top'
            }
        }
    }
});
</script>

<!-- ===== RECENT GRIEVANCES ===== -->
<h3 style="margin-top:30px;">Recent Grievances</h3>

<table class="table">
    <thead>
        <tr>
            <th>ID</th>
            <th>Title</th>
            <th>Status</th>

            {% if session.role == "hr" %}
            <th>Created By</th>
            <th>Action</th>
            {% endif %}
        </tr>
    </thead>

    <tbody>
        {% for g in recent_grievances %}
        <tr>
            <td>{{ g.id }}</td>
            <td>{{ g.title }}</td>
            <td>
                {% if g.status == "Open" %}
                    ğŸŸ¡ Pending
                {% else %}
                    ğŸŸ¢ Resolved
                {% endif %}
            </td>

            {% if session.role == "hr" %}
            <td>{{ g.created_by }}</td>
            <td>
                {% if g.status == "Open" %}
                    <a href="{{ url_for('resolve_grievance', id=g.id) }}">Resolve</a>
                {% else %}
                    âœ”
                {% endif %}
            </td>
            {% endif %}
        </tr>
        {% endfor %}
    </tbody>
</table>

{% endblock %}












